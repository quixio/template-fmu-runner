# Quix Project Descriptor
# This file describes the data pipeline and configuration of resources of a Quix Project.

metadata:
  version: 1.0

# This section describes the Deployments of the data pipeline
deployments:
  - name: Simulation API & UI
    application: http-api-source
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 500
      replicas: 1
    publicAccess:
      enabled: true
      urlPrefix: simulation-api
    state:
      enabled: true
      size: 1
    network:
      serviceName: simulation-api
      ports:
        - port: 80
          targetPort: 80
    variables:
      - name: USE_LOCAL_STORE
        inputType: FreeText
        description: QuixLake API URL for data lake queries
        required: true
        value: https://quixlake-quixers-quixlakev2timeseries-prod.az-france-0.app.quix.io
      - name: S3_ENDPOINT
        inputType: FreeText
        description: S3/MinIO endpoint URL for storing FMU models.
        value: http://minio:80
      - name: S3_ACCESS_KEY
        inputType: Secret
        description: S3 access key ID.
        secretKey: s3_user
      - name: S3_SECRET_KEY
        inputType: Secret
        description: S3 secret access key.
        secretKey: s3_password
      - name: S3_BUCKET
        inputType: FreeText
        description: S3 bucket name for FMU models.
        value: fmu-models
    plugin:
      embeddedView:
        enabled: true
        hideHeader: true
        default: true
      sidebarItem:
        show: true
        label: FMU Runner
        icon: drag_indicator
        order: 1
  - name: FMU Runner
    application: fmu-runner
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 500
      replicas: 1
    state:
      enabled: true
      size: 1
    variables:
      - name: input
        inputType: InputTopic
        description: Name of the input topic to listen to (simulation requests from HTTP API).
        value: simulation
      - name: output
        inputType: OutputTopic
        description: Name of the output topic to write simulation results to.
        value: simulation-results
      - name: S3_ENDPOINT
        inputType: FreeText
        description: S3/MinIO endpoint URL for fetching FMU model binaries.
        value: http://minio:80
      - name: S3_ACCESS_KEY
        inputType: Secret
        description: S3 access key ID.
        secretKey: s3_user
      - name: S3_SECRET_KEY
        inputType: Secret
        description: S3 secret access key.
        secretKey: s3_password
      - name: S3_BUCKET
        inputType: FreeText
        description: S3 bucket name for FMU models.
        value: fmu-models
  - name: Test Generator
    application: test-generator
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 500
      replicas: 1
    variables:
      - name: input
        inputType: InputTopic
        description: Topic for failed validations.
        value: validation-failure
      - name: output
        inputType: OutputTopic
        description: Topic to publish new test configurations.
        value: simulation
      - name: NUM_TESTS
        inputType: FreeText
        description: Number of test variations to generate per failure.
        value: 10
  - name: Quix DataLake Timeseries Sink
    application: quix-datalake-timeseries-sink
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 2000
      replicas: 1
    variables:
      - name: input
        inputType: InputTopic
        required: true
        value: validation-failure
      - name: input_success
        inputType: InputTopic
        value: validation-success
      - name: S3_BUCKET
        inputType: FreeText
        required: true
        value: datalake
      - name: S3_PREFIX
        inputType: FreeText
        required: true
        value: ts_test
      - name: TABLE_NAME
        inputType: FreeText
        required: true
        value: validation_failures
      - name: HIVE_COLUMNS
        inputType: FreeText
        required: true
        value: model_filename,year,month,day
      - name: TIMESTAMP_COLUMN
        inputType: FreeText
        required: true
        value: ts_ms
      - name: CATALOG_URL
        inputType: FreeText
        value: ''
      - name: CATALOG_AUTH_TOKEN
        inputType: Secret
        secretKey: catalog_token
      - name: AUTO_DISCOVER
        inputType: FreeText
        required: true
        value: true
      - name: CATALOG_NAMESPACE
        inputType: FreeText
        required: true
        value: default
      - name: BATCH_SIZE
        inputType: FreeText
        required: true
        value: 1000
      - name: COMMIT_INTERVAL
        inputType: FreeText
        required: true
        value: 30
      - name: KAFKA_KEY_DESERIALIZER
        inputType: FreeText
        required: true
        value: str
      - name: KAFKA_VALUE_DESERIALIZER
        inputType: FreeText
        required: true
        value: json
      - name: CONSUMER_GROUP
        inputType: FreeText
        required: true
        value: s3_direct_sink_v1.0
      - name: AUTO_OFFSET_RESET
        inputType: FreeText
        required: true
        value: earliest
      - name: AWS_ACCESS_KEY_ID
        inputType: Secret
        required: true
        secretKey: s3_user
      - name: AWS_SECRET_ACCESS_KEY
        inputType: Secret
        required: true
        secretKey: s3_password
      - name: AWS_REGION
        inputType: FreeText
        required: true
        value: local
      - name: AWS_ENDPOINT_URL
        inputType: FreeText
        required: true
        value: http://minio:80
      - name: LOGLEVEL
        inputType: FreeText
        required: true
        value: INFO
      - name: MAX_WRITE_WORKERS
        inputType: FreeText
        required: true
        value: 10
  - name: Run Validation
    application: validator
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 500
      replicas: 1
    variables:
      - name: input
        inputType: InputTopic
        description: Name of the input topic to listen to (simulation results).
        value: simulation-results
      - name: output_success
        inputType: OutputTopic
        description: Name of the output topic for successful validations.
        value: validation-success
      - name: output_failure
        inputType: OutputTopic
        description: Name of the output topic for failed validations.
        value: validation-failure
  - name: MinIO
    application: minio
    version: latest
    deploymentType: Service
    resources:
      cpu: 200
      memory: 800
      replicas: 1
    network:
      serviceName: minio
      ports:
        - port: 80
          targetPort: 9000
    variables:
      - name: MINIO_ROOT_USER
        inputType: Secret
        description: The root username to initialize Minio with
        required: true
        secretKey: s3_user
      - name: MINIO_ROOT_PASSWORD
        inputType: Secret
        description: The root password to initialize Minio with
        required: true
        secretKey: s3_password

# This section describes the Topics of the data pipeline
topics:
  - name: simulation
    dataTier: Bronze
  - name: simulation-results
    dataTier: Silver
  - name: validation-success
    dataTier: Gold
  - name: validation-failure
    dataTier: Silver
  - name: generated-opc_ua_data
    dataTier: Bronze
  - name: http_data
    dataTier: Bronze
  - name: normalized_data
    dataTier: Silver
